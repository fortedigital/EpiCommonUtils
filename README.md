# EpiCommonUtils

This is a set of common stuff which might be helpfull with your day to day EpiServer work

## Installation

It's available as a [nuget package](https://www.nuget.org/packages/Forte.EpiCommonUtils/)

## Features included:

1. [Hosting Environment](#hostingenvironment)
2. [Webpack](#webpack)
3. [FeatureViewLocationRazorEngine](#featureviewlocationrazorengine)
4. [Cache Warmup](#cache-warmup)
 
#### HostingEnvironment

Offers several flags saying on which environment solution is working on. It's based on `episerver:EnvironmentName` appSetting:

        IsLocalDev
        IsIntegration
        IsDev
        IsPreProd
        IsProd 


#### Webpack

It offers two methods. 

`public static string GetStylesheetUrl(string name)`


`public static string GetScriptUrl(string name)`

Those return paths to script/stylesheet containing unique hash generated by webpack. If solution is running on `IsLocalDev` it returns path to local webpack dev server.

You can configure path to local webpack dev server by setting `webpack:devServerUrl` appSetting value (the default is `https://localhost:8080/dist/`)

In order this tool work properly it requires file generated by [Assets webpack plugin](https://www.npmjs.com/package/assets-webpack-plugin). Default path checked is set to `/dist/webpack-assets.json`. 
You can override it by setting `webpack:manifestPath` appSetting 

#### FeatureViewLocationRazorEngine

This is extension of `RazonViewEngine` and it sets up location of templates with common pattern we've been using. 
Check source code of `FeatureViewLocationRazorEngine` for path details. 

This is by default initialized by EpiServer startup. You can disable this initialization by setting up `appSetting` called `epiCommonUtils:disableFeatureViewLocationRazor` with value `true`

#### StructureMap - DependencyInjection

In order for `StructureMap` to work as your Dependency Injection container you must register it - separately for MVC and WebApi controllers.
This package will do it for you by default. 

If you wish to disable this registration you can do it by setting flags in `appSettings`:

```xml

<appSettings>
    <!-- Disable MVC registration -->
    <add key="epiCommonUtils:disableStructureMapMvcRegistration" value="true" />
    <!-- Disable WebApi registration -->
    <add key="epiCommonUtils:disableStructureMapWebApiRegistration" value="true" />
</appSettings>
``` 

#### Cache Warmup

After application is started a lot of cache is still not warmup up - [Read more](https://docs.microsoft.com/en-us/iis/get-started/whats-new-in-iis-8/iis-80-application-initialization). 

This package adds and registeres `cache-warmup/warmup` url.
By visiting (sending GET request) this endpoint you will trigger an action which will:
1. try to find all PageTypes registered in your EpiServer installation,
2. get one url for every usage of a PageType
3. send request to such url so cache is warmed up
 
After cache is warmup up (url has been visited after application startup) this endpoint will just return empty response without performing any action.

You may want to set up your IIS to visit `cache-warmup/warmup` as a part of application initialization. 
To do so it's best to set up configuration transformation:

```xml
<configuration xmlns:xdt="http://schemas.microsoft.com/XML-Document-Transform">
  <system.webServer xdt:Transform="InsertIfMissing">
    <applicationInitialization xdt:Transform="Remove" />
    <applicationInitialization xdt:Transform="InsertIfMissing">
      <add initializationPage="/cache-warmup/warmup" xdt:Transform="InsertIfMissing" />
    </applicationInitialization>
  </system.webServer>
</configuration> 
```
